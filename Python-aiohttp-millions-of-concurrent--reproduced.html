<!DOCTYPE html>
<html lang="zh-Hans">
<head>

    <!--[if lt IE 9]>
        <style>body {display: none; background: none !important} </style>
        <meta http-equiv="Refresh" Content="0; url=//outdatedbrowser.com/" />
    <![endif]-->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="format-detection" content="telephone=no" />
<meta name="author" content="付腾飞" />



<meta name="description" content="本文是转载，合并了上下为一篇，这是我看到的最不啰嗦，最易理解的关于并发的文章。  出处：   Python-aiohttp百万并发(上) https:&#x2F;&#x2F;www.topjishu.com&#x2F;10935.html   Python-aiohttp百万并发(下) https:&#x2F;&#x2F;www.topjishu.com&#x2F;10938.html">
<meta property="og:type" content="article">
<meta property="og:title" content="Python-aiohttp百万并发-转载">
<meta property="og:url" content="http://example.com/Python-aiohttp-millions-of-concurrent--reproduced">
<meta property="og:site_name" content="一个DBA的工作学习笔记">
<meta property="og:description" content="本文是转载，合并了上下为一篇，这是我看到的最不啰嗦，最易理解的关于并发的文章。  出处：   Python-aiohttp百万并发(上) https:&#x2F;&#x2F;www.topjishu.com&#x2F;10935.html   Python-aiohttp百万并发(下) https:&#x2F;&#x2F;www.topjishu.com&#x2F;10938.html">
<meta property="og:locale">
<meta property="article:published_time" content="2017-12-21T11:11:25.000Z">
<meta property="article:modified_time" content="2021-06-13T14:39:37.194Z">
<meta property="article:author" content="付腾飞">
<meta property="article:tag" content="异步">
<meta property="article:tag" content="网络编程">
<meta name="twitter:card" content="summary">

<link rel="apple-touch-icon" href= "/apple-touch-icon.png">


    <link rel="alternate" href="/atom.xml" title="一个DBA的工作学习笔记" type="application/atom+xml">



    <link rel="shortcut icon" href="/favicon.ico">





    <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet">



    <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">



<link rel="stylesheet" href="/css/style.css">




<link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">


<title>Python-aiohttp百万并发-转载 | 一个DBA的工作学习笔记</title>

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

<script>
    var yiliaConfig = {
        fancybox: true,
        animate: false,
        isHome: false,
        isPost: true,
        isArchive: false,
        isTag: false,
        isCategory: false,
        fancybox_js: "//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js",
        scrollreveal: "//cdn.bootcss.com/scrollReveal.js/3.1.4/scrollreveal.min.js",
        search: true
    }
</script>


    <script>
        yiliaConfig.jquery_ui = [true, "//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js", "//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css"];
    </script>



    <script> yiliaConfig.rootUrl = "\/";</script>





    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?591c46a8271a85b8b13ca893fd7973e0";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


<meta name="generator" content="Hexo 5.4.0"></head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/img/avatar.jpg" class="animated zoomIn">
        </a>
        <hgroup>
            <h1 class="header-author">
                <a href="/">
                    
                </a>
            </h1>
        </hgroup>

        <br>

        

                <br>

                
                    <form id="search-form">
                        <input type="text" id="local-search-input" name="q" placeholder="search..." class="search form-control" autocomplete="off" autocorrect="off" searchonload="false" />
                        <i class="fa fa-times" onclick="resetSearch()"></i>
                    </form>
                    <div id="local-search-result"></div>
                    <p class='no-result'>No results found <i class='fa fa-spinner fa-pulse'></i></p>
                    


                        
                            <div id="switch-btn" class="switch-btn">
                                <div class="icon">
                                    <div class="icon-ctn">
                                        <div class="icon-wrap icon-house" data-idx="0">
                                            <div class="birdhouse"></div>
                                            <div class="birdhouse_holes"></div>
                                        </div>
                                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                                            <div class="ribbon"></div>
                                        </div>
                                        
                                            <div class="icon-wrap icon-link hide" data-idx="2">
                                                <div class="loopback_l"></div>
                                                <div class="loopback_r"></div>
                                            </div>
                                            
                                                
                                                    <div class="icon-wrap icon-me hide" data-idx="3">
                                                        <div class="user"></div>
                                                        <div class="shoulder"></div>
                                                    </div>
                                                    
                                    </div>

                                </div>
                                <div class="tips-box hide">
                                    <div class="tips-arrow"></div>
                                    <ul class="tips-inner">
                                        <li>
                                            菜单
                                        </li>
                                        <li>
                                            标签
                                        </li>
                                        
                                            <li>
                                                友情链接
                                            </li>
                                            
                                                
                                                    <li>
                                                        关于我
                                                    </li>
                                                    
                                    </ul>
                                </div>
                            </div>
                            

                                <div id="switch-area" class="switch-area">
                                    <div class="switch-wrap">
                                        <section class="switch-part switch-part1">
                                            <nav class="header-menu">
                                                <ul>
                                                    
                                                        <li>
                                                            <a href="/">
                                                                主页
                                                            </a>
                                                        </li>
                                                        
                                                        <li>
                                                            <a href="/archives/">
                                                                所有文章
                                                            </a>
                                                        </li>
                                                        
                                                        <li>
                                                            <a href="/tags/">
                                                                标签云
                                                            </a>
                                                        </li>
                                                        
                                                        <li>
                                                            <a href="/about/">
                                                                关于我
                                                            </a>
                                                        </li>
                                                        
                                                        <li>
                                                            <a href="/resume">
                                                                个人简历
                                                            </a>
                                                        </li>
                                                        
                                                </ul>
                                            </nav>
                                            <nav class="header-nav">
                                                <ul class="social">
                                                    
                                                        <a class="fa QQ" target="_blank" rel="noopener" href="http://sighttp.qq.com/msgrd?v=1&uin=2899109958" title="QQ"></a>
                                                        
                                                        <a class="fa Email" href="mailto:2899109958@qq.com" title="Email"></a>
                                                        
                                                        <a class="fa GitHub" href="/dbafu.github.io" title="GitHub"></a>
                                                        
                                                </ul>
                                            </nav>
                                        </section>

                                        
                                            <section class="switch-part switch-part2">
                                                <div class="widget tagcloud" id="js-tagcloud">
                                                    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaEE/" rel="tag">JavaEE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jsp/" rel="tag">Jsp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/" rel="tag">es6</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo%E6%8F%92%E4%BB%B6/" rel="tag">hexo插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jsp/" rel="tag">jsp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/md/" rel="tag">md</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/svn/" rel="tag">svn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tag1/" rel="tag">tag1</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tag2/" rel="tag">tag2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tag3/" rel="tag">tag3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/test/" rel="tag">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/" rel="tag">图像识别</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9B%BE%E5%83%8F%E9%A2%84%E5%A4%84%E7%90%86/" rel="tag">图像预处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%82%E6%AD%A5/" rel="tag">异步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%94%E7%A4%BA/" rel="tag">演示</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li></ul>
                                                </div>
                                            </section>
                                            

                                                
                                                    <section class="switch-part switch-part3">
                                                        <div id="js-friends">
                                                            
                                                                <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://hexo.io">
                                                                    Hexo
                                                                </a>
                                                                
                                                                <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="https://pages.github.com/">
                                                                    GitHub
                                                                </a>
                                                                
                                                                <a class="main-nav-link switch-friends-link" target="_blank" rel="noopener" href="http://moxfive.xyz/">
                                                                    MOxFIVE
                                                                </a>
                                                                
                                                        </div>
                                                    </section>
                                                    

                                                        
                                                            
                                                                        <section class="switch-part switch-part4">
                                                                            
                                                                                <div id="js-aboutme">
                                                                                    专注于前端
                                                                                </div>
                                                                        </section>
                                                                        
                                    </div>
                                </div>

        
                
                    <div class="category-block">
                    <h3 class="asidetitle">分类 ：</h3>
                      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/Docker/">Docker</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Webpack/">Webpack</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/jsp/">jsp</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/jsp/Tomcat/">Tomcat</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/react-native/">react-native</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/test1/">test1</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/test1/test2/">test2</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/test1/test2/test3/">test3</a><span class="category-list-count">1</span></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB/">图像识别</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB/">爬虫</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/">版本控制</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/">验证码识别</a><span class="category-list-count">1</span></li></ul>
                    </div>
                    
                    

    </header>
</div>

    </div>
    <div class="mid-col">
      
        <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页"></a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/img/avatar.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页"></a></h1>
            </hgroup>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                    <li><a href="/resume">个人简历</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fa QQ" target="_blank" href="http://sighttp.qq.com/msgrd?v=1&uin=2899109958" title="QQ"></a>
                            
                                <a class="fa Email" target="_blank" href="mailto:2899109958@qq.com" title="Email"></a>
                            
                                <a class="fa GitHub" target="_blank" href="/dbafu.github.io" title="GitHub"></a>
                            
                        </ul>
            </nav>
        </header>                
    </div>
    <link class="menu-list" tags="标签" friends="友情链接" about="关于我"/>
</nav>
        <div class="body-wrap"><article id="post-Python-aiohttp百万并发-转载" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/Python-aiohttp-millions-of-concurrent--reproduced" class="article-date">
      <time datetime="2017-12-21T11:11:25.000Z" itemprop="datePublished">2017-12-21</time>
</a>


    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Python-aiohttp百万并发-转载
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Python/">Python</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%82%E6%AD%A5/" rel="tag">异步</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <blockquote>
<p>本文是转载，合并了上下为一篇，这是我看到的最不啰嗦，最易理解的关于并发的文章。</p>
</blockquote>
<p>出处：</p>
<blockquote>
</blockquote>
<p>Python-aiohttp百万并发(上) <a target="_blank" rel="noopener" href="https://www.topjishu.com/10935.html">https://www.topjishu.com/10935.html</a></p>
<blockquote>
</blockquote>
<p>Python-aiohttp百万并发(下) <a target="_blank" rel="noopener" href="https://www.topjishu.com/10938.html">https://www.topjishu.com/10938.html</a></p>
<span id="more"></span>

<p>本文将测试<a target="_blank" rel="noopener" href="http://aiohttp.readthedocs.org/en/stable/">python aiohttp</a>的极限，同时测试其性能表现，以分钟发起请求数作为指标。大家都知道，当应用到网络操作时，异步的代码表现更优秀，但是验证这个事情，同时搞明白异步到底有多大的优势以及为什么会有这样的优势仍然是一件有趣的事情。为了验证，我将发起1000000请求，用aiohttp客户端。aiohttp每分钟能够发起多少请求？你能预料到哪些异常情况以及崩溃会发生，当你用比较粗糙的脚本去发起如此大量的请求？面对如此大量的请求，哪些主要的陷阱是你需要去思考的？</p>
<h2 id="初识-asyncio-aiohttp"><a href="#初识-asyncio-aiohttp" class="headerlink" title="初识 asyncio/aiohttp"></a>初识 asyncio/aiohttp</h2><p>异步编程并不简单。相比平常的同步编程，你需要付出更多的努力在使用回调函数，以事件以及事件处理器的模式进行思考。同时也是因为asyncio相对较新，相关的教程以及博客还很少的缘故。<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/asyncio.html">官方文档</a>非常简陋，只有最基本的范例。在我写本文的时候，Stack Overflow上面，只有410个与asyncio相关的话题（相比之下，twisted相关的有2585）。有个别关于asyncio的不错的博客以及文章，比如<a target="_blank" rel="noopener" href="http://aosabook.org/en/500L/a-web-crawler-with-asyncio-coroutines.html">这个</a>、<a target="_blank" rel="noopener" href="http://www.snarky.ca/how-the-heck-does-async-await-work-in-python-3-5">这个</a>、<a target="_blank" rel="noopener" href="http://sahandsaba.com/understanding-asyncio-node-js-python-3-4.html">这个</a>，或者还有<a target="_blank" rel="noopener" href="https://community.nitrous.io/tutorials/asynchronous-programming-with-python-3">这个</a>以及<a target="_blank" rel="noopener" href="https://compiletoi.net/fast-scraping-in-python-with-asyncio/">这个</a>。</p>
<p>简单起见，我们先从基础开始 —— 简单HTTP hello world —— 发起GET请求，同时获取一个单独的HTTP响应。</p>
<p>同步模式，你这么做：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>()</span></span><br><span class="line"><span class="function">     <span class="title">return</span> <span class="title">requests</span>.<span class="title">get</span>(<span class="params"><span class="string">&quot;http://httpbin.org/get&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">print</span>(<span class="params">hello(<span class="params"></span>)</span>)</span></span><br></pre></td></tr></table></figure>

<p>接着我们使用aiohttp：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3.5</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> ClientSession</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(<span class="string">&quot;http://httpbin.org/headers&quot;</span>) <span class="keyword">as</span> response:</span><br><span class="line">            response = <span class="keyword">await</span> response.read()</span><br><span class="line">            <span class="built_in">print</span>(response)</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(hello())</span><br></pre></td></tr></table></figure>

<p>好吧，看上去仅仅一个简单的任务，我写了很多的代码……那里有“<code>async def</code>”、“<code>async with</code>”、“<code>await</code>”—— 看上去让人迷惑，让我们尝试弄懂它们。</p>
<p>你使用**<a target="_blank" rel="noopener" href="https://www.python.org/dev/peps/pep-0492/#await-expression">async</a><strong>以及<code>await</code>关键字将函数异步化。在<code>hello()</code>中实际上有两个异步操作：首先</strong>异步获取相应<strong>，然后</strong>异步读取响应的内容**。</p>
<p><code>Aiohttp</code>推荐使用<code>ClientSession</code>作为主要的接口发起请求。<code>ClientSession</code>允许在多个请求之间保存<code>cookie</code>以及相关对象信息。<code>Session</code>(会话)<strong>在使用完毕之后需要关闭</strong>，<strong>关闭</strong><code>Session</code>是另一个异步操作，所以每次你都需要使用<code>async with</code>关键字。</p>
<p><strong>一旦你建立了客户端session，你可以用它发起请求。这里是又一个异步操作的开始</strong>。上下文管理器的<code>with</code>语句可以保证在处理<code>session</code>的时候，总是能正确的关闭它。</p>
<p><strong>要让你的程序正常的跑起来，你需要将他们加入事件循环中</strong>。所以你需要创建一个<code>asyncio loop</code>的实例， 然后将任务加入其中。</p>
<p>看起来有些困难，但是只要你花点时间进行思考与理解，就会有所体会，其实并没有那么复杂。</p>
<h2 id="访问多个链接"><a href="#访问多个链接" class="headerlink" title="访问多个链接"></a>访问多个链接</h2><p>现在我们来做些更有意思的事情，顺序访问多个链接。</p>
<p>同步方式如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">    <span class="built_in">print</span>(requests.get(url).text)</span><br></pre></td></tr></table></figure>

<p>很简单。不过异步方式却没有这么容易。所以任何时候你都需要思考，你的处境是否有必要用到异步。如果你的app在同步模式工作的很好，也许你并不需要将之迁移到异步方式。如果你确实需要异步方式，这里会给你一些启示。我们的异步函数<code>hello()</code>还是保持原样，不过我们需要将之包装在<code>asyncio</code>的<code>Future</code>对象中，然后将<code>Futur</code>e对象列表作为任务传递给事件循环。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">tasks = [] <span class="comment"># I&#x27;m using test server localhost, but you can use any url</span></span><br><span class="line">url = <span class="string">&quot;http://localhost:8080/&#123;&#125;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    task = asyncio.ensure_future(hello(url.<span class="built_in">format</span>(i)))</span><br><span class="line">    tasks.append(task)</span><br><span class="line"></span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure>
<p>现在假设我们想获取所有的响应，并将他们保存在同一个列表中。目前，我们没有保存响应内容，仅仅只是打印了他们。让我们返回他们，将之存储在一个列表当中，最后再打印出来。</p>
<p>为了达到这个目的，我们需要修改一下代码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3.5</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> ClientSession</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">url</span>):</span></span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">with</span> ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">      <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">await</span> response.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">loop,  r</span>):</span></span><br><span class="line">   url = <span class="string">&quot;http://localhost:8080/&#123;&#125;&quot;</span></span><br><span class="line">   tasks = []</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(r):</span><br><span class="line">       task = asyncio.ensure_future(fetch(url.<span class="built_in">format</span>(i)))</span><br><span class="line">       tasks.append(task)</span><br><span class="line">       responses = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br><span class="line">       <span class="comment"># you now have all response bodies in this variable</span></span><br><span class="line">       <span class="built_in">print</span>(responses)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_responses</span>(<span class="params">result</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">future = asyncio.ensure_future(run(loop, <span class="number">4</span>))</span><br><span class="line">loop.run_until_complete(future)</span><br></pre></td></tr></table></figure>

<p>注意**<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/asyncio-task.html#asyncio.gather">asyncio.gather()</a>**的用法，它搜集所有的<code>Future</code>对象，然后等待他们返回。</p>
<h2 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h2><p>现在我们来模拟真实场景，去调试一些错误，作为演示范例。</p>
<p>看看这个：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WARNING! BROKEN CODE DO NOT COPY PASTE</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">url</span>):</span></span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">with</span> ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">      <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">          <span class="keyword">return</span> response.read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果你对aiohttp或者asyncio不够了解，即使你很熟悉Python，这段代码也不好debug。</p>
<p>上面的代码产生如下输出：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pawel@pawel-VPCEH390X ~/p/l/benchmarker&gt; ./bench.py</span><br><span class="line">[&lt;generator <span class="built_in">object</span> ClientResponse.read at <span class="number">0x7fa68d465728</span>&gt;,</span><br><span class="line"> &lt;generator <span class="built_in">object</span> ClientResponse.read at <span class="number">0x7fa68cdd9468</span>&gt;,</span><br><span class="line"> &lt;generator <span class="built_in">object</span> ClientResponse.read at <span class="number">0x7fa68d4656d0</span>&gt;,</span><br><span class="line"> &lt;generator <span class="built_in">object</span> ClientResponse.read at <span class="number">0x7fa68cdd9af0</span>&gt;]</span><br></pre></td></tr></table></figure>
<p>发生了什么？你期待获得响应对象，但是你得到的是一组生成器。怎么会这样？</p>
<p>我之前提到过，<code>response.read()</code>是一个异步操作，这意味着它不会立即返回结果，仅仅返回生成器。这些生成器需要被调用跟运行，但是这并不是默认行为。在Python34中加入的<code>yield fro</code>m以及<strong>Python3.5</strong>中加入的<code>await</code>便是为此而生。它们将迭代这些生成器。以上代码只需要在<code>response.read()</code>前加上<code>await</code>关键字即可修复。如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># async operation must be preceded by await</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">await</span> response.read()</span><br><span class="line"><span class="comment"># NOT: return response.read()</span></span><br></pre></td></tr></table></figure>
<p>我们看看另一个例子。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># WARNING! BROKEN CODE DO NOT COPY PASTE</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">loop,  r</span>):</span></span><br><span class="line">   url = <span class="string">&quot;http://localhost:8080/&#123;&#125;&quot;</span></span><br><span class="line">   tasks = []</span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(r):</span><br><span class="line">       task = asyncio.ensure_future(fetch(url.<span class="built_in">format</span>(i)))</span><br><span class="line">       tasks.append(task)</span><br><span class="line">       responses = asyncio.gather(*tasks)</span><br><span class="line">       <span class="built_in">print</span>(responses)</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pawel@pawel-VPCEH390X ~/p/l/benchmarker&gt; ./bench.py</span><br><span class="line">&lt;_GatheringFuture pending&gt;</span><br><span class="line">Task was destroyed but it is pending!</span><br><span class="line">task: &lt;Task pending coro=&lt;fetch() running at ./bench.py:7&gt;</span><br><span class="line">        wait_for=&lt;Future pending cb=[Task._wakeup()]&gt;</span><br><span class="line">        cb=[gather.&lt;locals&gt;._done_callback(0)()</span><br><span class="line">        at /usr/<span class="built_in">local</span>/lib/python3.5/asyncio/tasks.py:602]&gt;</span><br><span class="line">Task was destroyed but it is pending!</span><br><span class="line">task: &lt;Task pending coro=&lt;fetch() running at ./bench.py:7&gt;</span><br><span class="line">　　wait_for=&lt;Future pending cb=[Task._wakeup()]&gt;</span><br><span class="line">　　cb=[gather.&lt;locals&gt;._done_callback(1)()</span><br><span class="line">　　at /usr/<span class="built_in">local</span>/lib/python3.5/asyncio/tasks.py:602]&gt;</span><br><span class="line">Task was destroyed but it is pending!</span><br><span class="line">task: &lt;Task pending coro=&lt;fetch() running at ./bench.py:7&gt;</span><br><span class="line">　　wait_for=&lt;Future pending cb=[Task._wakeup()]&gt;</span><br><span class="line">　　cb=[gather.&lt;locals&gt;._done_callback(2)()</span><br><span class="line">　　at /usr/<span class="built_in">local</span>/lib/python3.5/asyncio/tasks.py:602]&gt;</span><br><span class="line">Task was destroyed but it is pending!</span><br><span class="line">task: &lt;Task pending coro=&lt;fetch() running at ./bench.py:7&gt;</span><br><span class="line">　　wait_for=&lt;Future pending cb=[Task._wakeup()]&gt;</span><br><span class="line">　　cb=[gather.&lt;locals&gt;._done_callback(3)()</span><br><span class="line">　　at /usr/<span class="built_in">local</span>/lib/python3.5/asyncio/tasks.py:602]&gt;</span><br></pre></td></tr></table></figure>
<p>发生了什么？查看本地日志，你会发现没有任何请求到达服务器，实际上没有任何请求发生。打印信息首先打印&lt;_Gathering pending&gt;对象，然后警告等待的任务被销毁。又一次的，你忘记了await。</p>
<p>修改</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responses = asyncio.gather(*tasks)</span><br></pre></td></tr></table></figure>
<p>为</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">responses = <span class="keyword">await</span> asyncio.gather(*tasks)</span><br></pre></td></tr></table></figure>
<p>即可解决问题。</p>
<p>经验：任何时候，你在等待什么的时候，记得使用<code>await</code>。</p>
<p><a target="_blank" rel="noopener" href="https://www.topjishu.com/10938.html">Python-aiohttp百万并发(下)</a></p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><hr>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/6582.html">httpd四之CGI、HTTPS、压缩配置</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/10938.html">Python-aiohttp百万并发(下)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/10532.html">docker存储结构解析</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/9993.html">Memory_profiler：Python代码的内存分析器</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/8441.html">PYTHON 包管理工具解惑</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/6951.html">用 Python 脚本实现对 Linux 服务器的监控</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.topjishu.com/10938.html">Python-aiohttp百万并发(下)</a></p>
<h2 id="同步-vs-异步"><a href="#同步-vs-异步" class="headerlink" title="同步 vs 异步"></a>同步 vs 异步</h2><p>重头戏来了。我们来验证异步是否值得（编码麻烦）。看看同步与异步（client）效率上的区别。异步每分钟能够发起多少请求。</p>
<p>为此，我们首先配置一个异步的aiohttp服务器端。这个服务端将获取全部的html文本， 来自Marry Shelley的Frankenstein。在每个响应中，它将添加随机的延时。有的为0，最大值为3s。类似真正的app。有些app的响应延时为固定值，一般而言，每个响应的延时是不同的。</p>
<p>服务器代码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3.5</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># set seed to ensure async and sync client get same distribution of delay values</span></span><br><span class="line"><span class="comment"># and tests are fair random.seed(1)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">request</span>):</span></span><br><span class="line">    name = request.match_info.get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;foo&quot;</span>)</span><br><span class="line">    n = datetime.now().isoformat()</span><br><span class="line">    delay = random.randint(<span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(delay)</span><br><span class="line">    headers = &#123;<span class="string">&quot;content_type&quot;</span>: <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;delay&quot;</span>: <span class="built_in">str</span>(delay)&#125;</span><br><span class="line">    <span class="comment"># opening file is not async here, so it may block, to improve</span></span><br><span class="line">    <span class="comment"># efficiency of this you can consider using asyncio Executors</span></span><br><span class="line">    <span class="comment"># that will delegate file operation to separate thread or process</span></span><br><span class="line">    <span class="comment"># and improve performance</span></span><br><span class="line">    <span class="comment"># https://docs.python.org/3/library/asyncio-eventloop.html#executor</span></span><br><span class="line">    <span class="comment"># https://pymotw.com/3/asyncio/executors.html</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;frank.html&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> html_body:</span><br><span class="line">         <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;: &#123;&#125; delay: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(n, request.path, delay))</span><br><span class="line">         response = web.Response(body=html_body.read(), headers=headers)</span><br><span class="line">         <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">app = web.Application()</span><br><span class="line">app.router.add_route(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;/&#123;name&#125;&quot;</span>, hello)</span><br><span class="line">web.run_app(app)</span><br></pre></td></tr></table></figure>
<p>同步客户端代码如下：</p>
<p>同步代码</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests  <span class="comment">#requests 并不支持异步请求，异步请求使用aiohttp</span></span><br><span class="line">r = <span class="number">100</span></span><br><span class="line">url = <span class="string">&quot;http://localhost:8080/&#123;&#125;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(r):</span><br><span class="line">   res = requests.get(url.<span class="built_in">format</span>(i))</span><br><span class="line">  delay = res.headers.get(<span class="string">&quot;DELAY&quot;</span>)</span><br><span class="line">  d = res.headers.get(<span class="string">&quot;DATE&quot;</span>)</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;:&#123;&#125; delay &#123;&#125;&quot;</span>.<span class="built_in">format</span>(d, res.url, delay))</span><br></pre></td></tr></table></figure>

<p>异步代码</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> ClientSession</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">start = datetime.now()</span><br><span class="line">r = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">url</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">            delay = response.headers.get(<span class="string">&quot;delay&quot;</span>)</span><br><span class="line">            d = response.headers.get(<span class="string">&quot;DATE&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;:&#123;&#125; delay &#123;&#125;&quot;</span>.<span class="built_in">format</span>(d, response.url, delay))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.read()</span><br><span class="line"></span><br><span class="line">tasks = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(r):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&gt;&quot;</span> * <span class="number">20</span>, <span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(i))</span><br><span class="line">    url = <span class="string">&quot;http://localhost:8080/&#123;&#125;&quot;</span></span><br><span class="line">    url = url.<span class="built_in">format</span>(i)</span><br><span class="line">    <span class="built_in">print</span>(url)</span><br><span class="line">    task = asyncio.ensure_future(hello(url))</span><br><span class="line">    tasks.append(task)</span><br><span class="line"></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line">end = datetime.now()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;经历了时间为:&quot;</span>, (end - start).seconds)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>在我的机器上，上面的代码耗时2分45s。而异步代码只需要3.48s。</p>
<p>有趣的是，异步代码耗时无限接近最长的延时（server的配置）。如果你观察打印信息，你会发现异步客户端的优势有多么巨大。有的响应为0延迟，有的为3s。同步模式下，客户端会阻塞、等待，你的机器什么都不做。异步客户端不会浪费时间，当有延迟发生时，它将去做其他的事情。在日志中，你也会发现这个现象。首先是0延迟的响应，然后当它们到达后，你将看到1s的延迟，最后是最大延迟的响应。</p>
<h2 id="极限测试"><a href="#极限测试" class="headerlink" title="极限测试"></a>极限测试</h2><p>现在我们知道异步表现更好，让我们尝试去找到它的极限，同时尝试让它崩溃。我将发送1000异步请求。我很好奇我的客户端能够处理多少数量的请求。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; time python3 bench.py</span><br><span class="line">2.68user 0.24system 0:07.14elapsed 40%CPU</span><br><span class="line">(0avgtext+0avgdata 53704maxresident)</span><br><span class="line">k 0inputs+0outputs (0major+14156minor)pagefaults 0swaps</span><br></pre></td></tr></table></figure>
<p>1000个请求，花费了7s。相当不错的成绩。然后10K呢？很不幸，失败了：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">responses are &lt;_GatheringFuture finished exception=</span><br><span class="line">　　ClientOSError(<span class="number">24</span>, <span class="string">&#x27;Cannot connect to host localhost:8080 ssl:</span></span><br><span class="line"><span class="string">　　False [Can not connect to localhost:8080 [Too many open files]]&#x27;</span>)&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">   File <span class="string">&quot;/home/pawel/.local/lib/python3.5/site-packages/aiohttp/connector.py&quot;</span>, line <span class="number">581</span>, <span class="keyword">in</span> _create_connection</span><br><span class="line">   File <span class="string">&quot;/usr/local/lib/python3.5/asyncio/base_events.py&quot;</span>, line <span class="number">651</span>, <span class="keyword">in</span> create_connection</span><br><span class="line">   File <span class="string">&quot;/usr/local/lib/python3.5/asyncio/base_events.py&quot;</span>, line <span class="number">618</span>, <span class="keyword">in</span> create_connection</span><br><span class="line">   File <span class="string">&quot;/usr/local/lib/python3.5/socket.py&quot;</span>, line <span class="number">134</span>, <span class="keyword">in</span> __init__ OS</span><br><span class="line">   Error: [Errno <span class="number">24</span>] Too many <span class="built_in">open</span> files</span><br></pre></td></tr></table></figure>
<p>这样不大好，貌似我倒在了<a target="_blank" rel="noopener" href="http://www.webcitation.org/6ICibHuyd">10K connections problem</a>面前。</p>
<p>traceback显示，open files太多了，可能代表着open sockets太多。为什么叫文件？Sockets（套接字）仅仅是文件描述符，操作系统有数量的限制。多少才叫太多呢？我查看Python源码，然后发现这个值为1024.怎么样绕过这个问题？一个粗暴的办法是增加这个数值，但是听起来并不高明。更好的办法是，加入一些同步机制，限制并发数量。于是我在<a target="_blank" rel="noopener" href="https://docs.python.org/3/library/asyncio-sync.html#asyncio.Semaphore">asyncio.Semaphore()</a>中加入最大任务限制为1000.</p>
<p>修改客户端代码如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># modified fetch function with semaphore</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> ClientSession</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">url</span>):</span></span><br><span class="line">   <span class="keyword">async</span> <span class="keyword">with</span> ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">       <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">       　delay = response.headers.get(<span class="string">&quot;DELAY&quot;</span>)</span><br><span class="line">       　date = response.headers.get(<span class="string">&quot;DATE&quot;</span>)</span><br><span class="line">       　<span class="built_in">print</span>(<span class="string">&quot;&#123;&#125;:&#123;&#125; with delay &#123;&#125;&quot;</span>.<span class="built_in">format</span>(date, response.url, delay))</span><br><span class="line">       　<span class="keyword">return</span> <span class="keyword">await</span> response.read()</span><br><span class="line">       　</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">bound_fetch</span>(<span class="params">sem, url</span>):</span></span><br><span class="line">    <span class="comment"># getter function with semaphore</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">    　<span class="keyword">await</span> fetch(url)</span><br><span class="line">    　</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">loop,  r</span>):</span></span><br><span class="line">　url = <span class="string">&quot;http://localhost:8080/&#123;&#125;&quot;</span></span><br><span class="line">　tasks = []</span><br><span class="line">　<span class="comment"># create instance of Semaphore</span></span><br><span class="line">　sem = asyncio.Semaphore(<span class="number">1000</span>)</span><br><span class="line">　<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(r):</span><br><span class="line">　    <span class="comment"># pass Semaphore to every GET request</span></span><br><span class="line">　    task = asyncio.ensure_future(bound_fetch(sem, url.<span class="built_in">format</span>(i)))</span><br><span class="line">　    tasks.append(task)</span><br><span class="line">　    responses = asyncio.gather(*tasks)</span><br><span class="line">      <span class="keyword">await</span> responses</span><br><span class="line"></span><br><span class="line">number = <span class="number">10000</span></span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">future = asyncio.ensure_future(run(loop, number))</span><br><span class="line">loop.run_until_complete(future)</span><br></pre></td></tr></table></figure>
<p>现在，我们可以处理10k链接了。这花去我们23s，同时返回了一些异常。不过不管怎样，相当不错的表现。</p>
<p>那100K呢？这个任务让我的机器很吃力，不过惊奇的是，它工作的很好。服务器的表现相当稳定，虽然内存占用很高，然后cpu占用一直维持在100%左右。让我觉得有趣的是，服务器占用的cpu明显小于client。这是ps的回显：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pawel@pawel-VPCEH390X ~/p/l/benchmarker&gt; ps ua | grep python</span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">pawel     2447 56.3  1.0 216124 64976 pts/9    Sl+  21:26   1:27 /usr/<span class="built_in">local</span>/bin/python3.5 ./test_server.py</span><br><span class="line">pawel     2527  101  3.5 674732 212076 pts/0   Rl+  21:26   2:30 /usr/<span class="built_in">local</span>/bin/python3.5 ./bench.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最终因为某些原因，运行5分钟过后，它崩溃了。它生成了接近100K行的输出，所以很难定位traceback，好像某些响应没有正常关闭。具体原因不太确定。(client or server error)</p>
<p>一段时间的滚动以后，我找到了这个异常，在client日志中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">File <span class="string">&quot;/usr/local/lib/python3.5/asyncio/futures.py&quot;</span>, line 387, <span class="keyword">in</span> __iter__</span><br><span class="line">    <span class="built_in">return</span> self.result()  <span class="comment"># May raise too.</span></span><br><span class="line">File <span class="string">&quot;/usr/local/lib/python3.5/asyncio/futures.py&quot;</span>, line 274, <span class="keyword">in</span> result</span><br><span class="line">     raise self._exception</span><br><span class="line">File <span class="string">&quot;/usr/local/lib/python3.5/asyncio/selector_events.py&quot;</span>, line 411, <span class="keyword">in</span> _sock_connect</span><br><span class="line">     sock.connect(address) OS</span><br><span class="line">Error: [Errno 99] Cannot assign requested address</span><br></pre></td></tr></table></figure>
<p>我不太确定这里发生了什么。我初始的猜测是测试服务器挂掉了。一个读者提出：这个异常的发生原因是操作系统的可用端口耗尽。之前我限制了并发连接数最大为1k，可能有些sockets仍然处在closing状态，系统内核无法使用才导致这个问题。</p>
<p>已经很不错了，不是吗？100k耗时5分钟。相当于一分钟20k请求数。</p>
<p>最后我尝试1M连接数。我真怕我的笔记本因为这个爆炸^_^.我特意将延迟降低为0到1s之间。最终耗时52分钟。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1913.06</span>user <span class="number">1196.09</span>system <span class="number">52</span>:<span class="number">06.87</span>elapsed <span class="number">99</span>%CPU</span><br><span class="line">(0avgtext+0avgdata 5194260maxresident)k <span class="number">265144</span></span><br><span class="line">inputs+0outputs (18692major+2528207minor)</span><br><span class="line">pagefaults 0swaps</span><br></pre></td></tr></table></figure>
<p>这意味着，我们的客户端每分钟发送了19230次请求。还不错吧？注意客户端的性能被服务器限制了，好像服务器端崩溃了好几次。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>如你所见，异步HTTP客户端相当强大。发起1M请求不是那么困难，同时相比同步模式，优势巨大。</p>
<p>我好奇对比其他的语言或者异步框架，其表现如何？可能在以后某个时候，我将对比<a target="_blank" rel="noopener" href="https://github.com/twisted/treq">Twisted Treq</a>跟aiohttp。然后，其他的异步库(其他语言)能够支持到多少并发？比如：某些Java 异步框架？或者C++框架？或者某些Rust HTTP客户端？</p>
<h3 id="相关文章-1"><a href="#相关文章-1" class="headerlink" title="相关文章"></a>相关文章</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/8680.html">MySQL复制中slave延迟监控</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/10158.html">TCP: time wait bucket table overflow</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/9406.html">limit_zone 和 limit_req_zone nginx 下的限制连接模块</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/6326.html">Http 请求头中的 Proxy-Connection</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/11089.html">nginx HTTP 错误码499的含义</a></li>
<li><a target="_blank" rel="noopener" href="https://www.topjishu.com/6449.html">一个HTTP小问题</a></li>
</ul>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/Python-aiohttp-millions-of-concurrent--reproduced">Python-aiohttp百万并发-转载</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页"></a></p>
        <p><span>发布时间:</span>2017-12-21, 11:11:25</p>
        <p><span>最后更新:</span>2021-06-13, 22:39:37</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/Python-aiohttp-millions-of-concurrent--reproduced" title="Python-aiohttp百万并发-转载">http://example.com/Python-aiohttp-millions-of-concurrent--reproduced</a>
            <span class="copy-path" data-clipboard-text="原文: http://example.com/Python-aiohttp-millions-of-concurrent--reproduced　　作者: " title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
            <div id="article-nav-newer" class="article-nav-title">
                <a href="/The-latest-Python-asynchronous-programming-Detailed--reproduced">
                    最新Python异步编程详解-转载
                </a>
            </div>
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/Wrote-a-hexo-title-translation-Python-script">
                    写了一个hexo 标题翻译的Python脚本
                </a>
            </div>
        
    </nav>

  
</article>



    
<div class="share">
    
        <div class="bdsharebuttonbox">
            <a href="#" class="fa fa-twitter bds_twi" data-cmd="twi" title="分享到推特"></a>
            <a href="#" class="fa fa-weibo bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
            <a href="#" class="fa fa-qq bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
            <a href="#" class="fa fa-files-o bds_copy" data-cmd="copy" title="复制网址"></a>
            <a href="#" class="fa fa fa-envelope-o bds_mail" data-cmd="mail" title="通过邮件分享"></a>
            <a href="#" class="fa fa-weixin bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
            <a href="#" class="fa fa-share-alt bds_more" data-cmd="more"></i></a>
        </div>
        <script>
            window._bd_share_config={
                "common":{"bdSnsKey":{},"bdText":"Python-aiohttp百万并发-转载　| 一个DBA的工作学习笔记　","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
        </script>
    

    
</div>







    




    <div class="scroll" id="post-nav-button">
        
            <a href="/The-latest-Python-asynchronous-programming-Detailed--reproduced" title="上一篇: 最新Python异步编程详解-转载">
                <i class="fa fa-angle-left"></i>
            </a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/Wrote-a-hexo-title-translation-Python-script" title="下一篇: 写了一个hexo 标题翻译的Python脚本">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/10/%E5%9C%A8MacOS-10-14-1%E4%B8%8B%E6%90%AD%E5%BB%BAreact-native%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">在MacOS 10.14.1下搭建react-native开发环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/03/%E4%BD%BF%E7%94%A8webpack%E6%90%AD%E5%BB%BAes6%E7%8E%AF%E5%A2%83-20180902/">使用webpack搭建es6环境 --20180902</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/06/SVN-%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">SVN 学习记录</a></li><li class="post-list-item"><a class="post-list-link" href="/In-centos6.9-Java-ee-configuration-operating%20environment">在centos6.9下为Java-ee配置运行环境</a></li><li class="post-list-item"><a class="post-list-link" href="/Mac-use-settings-eclipse-and-Tomcat-to-run-JSP">mac 下使用设置eclipse和Tomcat 运行JSP</a></li><li class="post-list-item"><a class="post-list-link" href="/Selenium-Automation-Based-on-Python---Capturing-Code-Captures">基于Python的Selenium自动化— 实现验证码截取</a></li><li class="post-list-item"><a class="post-list-link" href="/Save-the-data-to-catch---reptile-mongodb">把抓到数据存起来——爬虫绝配mongodb</a></li><li class="post-list-item"><a class="post-list-link" href="/Heap-python-data-structure-and-its-realization">python 数据结构之堆及其实现</a></li><li class="post-list-item"><a class="post-list-link" href="/python-data-structure-of-sort-structure-of-the-tree">python 数据结构之排序</a></li><li class="post-list-item"><a class="post-list-link" href="/python-data-structure-of-the-tree">python 数据结构之树</a></li><li class="post-list-item"><a class="post-list-link" href="/python-data-structure-of-the-queue-and-stack">python 数据结构之队列和栈</a></li><li class="post-list-item"><a class="post-list-link" href="/The-latest-Python-asynchronous-programming-Detailed--reproduced">最新Python异步编程详解-转载</a></li><li class="post-list-item"><a class="post-list-link" href="/Python-aiohttp-millions-of-concurrent--reproduced">Python-aiohttp百万并发-转载</a></li><li class="post-list-item"><a class="post-list-link" href="/Wrote-a-hexo-title-translation-Python-script">写了一个hexo 标题翻译的Python脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/Use-scrapy-splash-to-rewrite-the-omelette-web-crawler">使用scrapy splash 重写煎蛋网图片爬虫</a></li><li class="post-list-item"><a class="post-list-link" href="/omelete-picture-crawler-one">煎蛋网图片爬虫一枚</a></li><li class="post-list-item"><a class="post-list-link" href="/hexo-insert-images-in-the-article">hexo文章中插入图片</a></li><li class="post-list-item"><a class="post-list-link" href="/python-identification-verification-code-the-general-number-plus-alphabet-verification-code-recognition">python识别验证码——一般的数字加字母验证码识别</a></li><li class="post-list-item"><a class="post-list-link" href="/docker-quickly-build-mysql-multi-instance-service,-and-data-volume-separation">用Docker快速搭建Mysql多实例服务，并进行数据卷分离</a></li><li class="post-list-item"><a class="post-list-link" href="/hexo-blog-to-ad-comon-plug-ins">hexo博客添加常用插件</a></li><li class="post-list-item"><a class="post-list-link" href="/obtain-the-proxy-ip-neded-for-the-crawler">获取爬虫所需要的代理IP</a></li><li class="post-list-item"><a class="post-list-link" href="/markdown-11-kinds-of-basic-gramar-%5Bswitch%5D">Markdown 11 种基本语法  [转]</a></li><li class="post-list-item"><a class="post-list-link" href="/build-a-blog-using-hexo-and-github-pages">使用Hexo和github pages搭建博客</a></li><li class="post-list-item"><a class="post-list-link" href="/hexo-change-the-theme-and-customization">hexo更换主题并个性化定制</a></li><li class="post-list-item"><a class="post-list-link" href="/mark-fly-like">马克飞象</a></li><li class="post-list-item"><a class="post-list-link" href="/markdown-cheatshet">Markdown Cheatsheet</a></li><li class="post-list-item"><a class="post-list-link" href="/helo-world">Hello World</a></li></ul>




    <script>
        
    </script>
</div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-right">
                <i class="fa fa-copyright"></i>
                2017-2021 付腾飞
            </div>
        </div>

    </div>
</footer>

        
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.2.0/require.min.js"></script>





    <script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" onclick="load$hide();" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    // Open in New Window
    
        var oOpenInNew = {
            
            
            
            
            
            
             archives: ".archive-article-title", 
             miniArchives: "a.post-list-link", 
            
             friends: "#js-friends a", 
             socail: ".social a" 
        }
        for (var x in oOpenInNew) {
            $(oOpenInNew[x]).attr("target", "_blank");
        }
    
</script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>
